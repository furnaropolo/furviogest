{{template "base" .}}

{{define "content"}}
<div class="page-header">
    <div>
        <h1>Apparati - {{.Data.Nave.Nome}}</h1>
        <p class="subtitle">{{.Data.Nave.NomeCompagnia}}</p>
    </div>
    <div class="header-actions">
        <a href="/navi/observium/{{.Data.Nave.ID}}" class="btn btn-secondary">Configura Observium</a>
        <button type="button" class="btn btn-info" onclick="runDiscovery()">Discovery</button>
        {{if .Session.IsTecnico}}
        <a href="/navi/apparati/nuovo/{{.Data.Nave.ID}}" class="btn btn-primary">Nuovo Apparato</a>
        {{end}}
    </div>
</div>

{{if .Data.Nave.ObserviumIP}}
<div class="observium-status card mb-3">
    <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <strong>Observium:</strong> {{.Data.Nave.ObserviumIP}}
                <span id="observium-status" class="badge badge-secondary">Non testato</span>
            </div>
            <button class="btn btn-sm btn-outline-primary" onclick="testObservium()">Test Connessione</button>
        </div>
    </div>
</div>
{{else}}
<div class="alert alert-warning">
    <strong>Observium non configurato.</strong> 
    <a href="/navi/observium/{{.Data.Nave.ID}}">Configura ora</a> per abilitare il discovery automatico.
</div>
{{end}}

<!-- Discovery Results Modal -->
<div id="discovery-modal" class="modal" style="display:none">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Discovery Dispositivi</h3>
            <button class="close-btn" onclick="closeDiscoveryModal()">&times;</button>
        </div>
        <div class="modal-body" id="discovery-results">
            <p class="text-center"><em>Avvio discovery...</em></p>
        </div>
    </div>
</div>

{{if .Data.Apparati}}
<div class="apparati-grid">
    {{range .Data.Apparati}}
    <div class="apparato-card" data-id="{{.ID}}">
        <div class="apparato-header" style="border-left: 4px solid {{.TipoColore}}">
            <div class="apparato-icon" style="background: {{.TipoColore}}">
                <span class="icon-{{.TipoIcona}}">{{if .Tipo}}{{slice .Tipo 0 2}}{{else}}--{{end}}</span>
            </div>
            <div class="apparato-info">
                <h4>{{.Nome}}</h4>
                <span class="tipo-badge" style="background: {{.TipoColore}}20; color: {{.TipoColore}}">{{.Tipo}}</span>
            </div>
            <div class="apparato-status status-{{.Stato}}" id="status-{{.ID}}">
                {{if eq .Stato "online"}}ONLINE{{else if eq .Stato "offline"}}OFFLINE{{else}}?{{end}}
            </div>
        </div>
        <div class="apparato-body">
            {{if .IP}}<div class="info-row"><span class="label">IP:</span> <code>{{.IP}}</code></div>{{end}}
            {{if .Vendor}}<div class="info-row"><span class="label">Vendor:</span> {{.Vendor}}</div>{{end}}
            {{if .Modello}}<div class="info-row"><span class="label">Modello:</span> {{.Modello}}</div>{{end}}
            {{if .Location}}<div class="info-row"><span class="label">Location:</span> {{.Location}}</div>{{end}}
        </div>
        <div class="apparato-footer">
            <div class="credentials-icons">
                {{if .SSHUser}}<span class="cred-icon" title="SSH configurato">SSH</span>{{end}}
                {{if .HTTPUser}}<span class="cred-icon" title="HTTP configurato">HTTP</span>{{end}}
                {{if .SNMPCommunity}}<span class="cred-icon" title="SNMP configurato">SNMP</span>{{end}}
            </div>
            <div class="apparato-actions">
                <button class="btn btn-sm btn-outline-info" onclick="checkApparato({{.ID}})">Check</button>
                {{if .IP}}
                {{if .HTTPSEnabled}}
                <a href="https://{{.IP}}:{{.HTTPPort}}" target="_blank" class="btn btn-sm btn-outline-secondary">Web</a>
                {{else if .HTTPPort}}
                <a href="http://{{.IP}}:{{.HTTPPort}}" target="_blank" class="btn btn-sm btn-outline-secondary">Web</a>
                {{end}}
                {{end}}
                {{if $.Session.IsTecnico}}
                <a href="/navi/apparato/modifica/{{.ID}}" class="btn btn-sm btn-secondary">Modifica</a>
                <a href="/navi/apparato/elimina/{{.ID}}" class="btn btn-sm btn-danger" onclick="return confirm('Eliminare?')">X</a>
                {{end}}
            </div>
        </div>
    </div>
    {{end}}
</div>

<div class="mt-3">
    <button class="btn btn-info" onclick="checkAllApparati()">Check Tutti</button>
</div>
{{else}}
<div class="empty-state">
    <h3>Nessun apparato registrato</h3>
    <p>Configura Observium ed esegui un Discovery, oppure aggiungi gli apparati manualmente.</p>
    {{if .Session.IsTecnico}}
    <a href="/navi/apparati/nuovo/{{.Data.Nave.ID}}" class="btn btn-primary">Aggiungi Apparato</a>
    {{end}}
</div>
{{end}}

<div class="mt-3">
    <a href="/navi/dettaglio/{{.Data.Nave.ID}}" class="btn btn-secondary">Torna al Dettaglio Nave</a>
    <a href="/navi" class="btn btn-outline-secondary">Lista Navi</a>
</div>

<script>
var naveID = {{.Data.Nave.ID}};

function testObservium() {
    var ip = '{{.Data.Nave.ObserviumIP}}';
    if (!ip) { alert('IP Observium non configurato'); return; }
    
    document.getElementById('observium-status').className = 'badge badge-warning';
    document.getElementById('observium-status').innerText = 'Testing...';
    
    fetch('/api/test-connection?ip=' + encodeURIComponent(ip) + '&type=ping')
        .then(r => r.json())
        .then(data => {
            var badge = document.getElementById('observium-status');
            if (data.success) {
                badge.className = 'badge badge-success';
                badge.innerText = 'Online (' + data.latency + 'ms)';
            } else {
                badge.className = 'badge badge-danger';
                badge.innerText = 'Offline';
            }
        });
}

function checkApparato(id) {
    var statusEl = document.getElementById('status-' + id);
    statusEl.innerText = '...';
    statusEl.className = 'apparato-status status-checking';
    
    fetch('/api/check-apparato?id=' + id)
        .then(r => r.json())
        .then(data => {
            statusEl.innerText = data.status.toUpperCase();
            statusEl.className = 'apparato-status status-' + data.status;
        });
}

function checkAllApparati() {
    var cards = document.querySelectorAll('.apparato-card');
    cards.forEach(function(card) {
        var id = card.dataset.id;
        checkApparato(id);
    });
}

function runDiscovery() {
    document.getElementById('discovery-modal').style.display = 'flex';
    document.getElementById('discovery-results').innerHTML = '<p class="text-center"><em>Esecuzione discovery...</em></p>';
    
    fetch('/api/discovery-devices?nave_id=' + naveID)
        .then(r => r.json())
        .then(data => {
            var html = '';
            if (data.success && data.devices.length > 0) {
                html = '<table class="table"><thead><tr><th>Hostname</th><th>IP</th><th>Tipo</th><th>Vendor</th><th>Azione</th></tr></thead><tbody>';
                data.devices.forEach(function(d) {
                    html += '<tr>';
                    html += '<td>' + d.Hostname + '</td>';
                    html += '<td><code>' + d.IP + '</code></td>';
                    html += '<td>' + (d.Type || '-') + '</td>';
                    html += '<td>' + (d.Vendor || '-') + '</td>';
                    html += '<td><button class="btn btn-sm btn-primary" onclick="importDevice(\'' + 
                            d.Hostname + '\',\'' + d.IP + '\',\'' + (d.Type||'Altro') + '\',\'' + 
                            (d.Vendor||'') + '\',\'' + (d.Location||'') + '\',\'' + (d.MAC||'') + '\')">Importa</button></td>';
                    html += '</tr>';
                });
                html += '</tbody></table>';
            } else {
                html = '<div class="alert alert-info">' + data.message + '</div>';
            }
            document.getElementById('discovery-results').innerHTML = html;
        })
        .catch(function(err) {
            document.getElementById('discovery-results').innerHTML = '<div class="alert alert-danger">Errore: ' + err + '</div>';
        });
}

function importDevice(hostname, ip, type, vendor, location, mac) {
    var formData = new FormData();
    formData.append('nave_id', naveID);
    formData.append('hostname', hostname);
    formData.append('ip', ip);
    formData.append('type', type);
    formData.append('vendor', vendor);
    formData.append('location', location);
    formData.append('mac', mac);
    
    fetch('/api/import-device', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('Dispositivo importato!');
                location.reload();
            } else {
                alert('Errore: ' + data.message);
            }
        });
}

function closeDiscoveryModal() {
    document.getElementById('discovery-modal').style.display = 'none';
}
</script>

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1.5rem;
}
.header-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}
.subtitle {
    color: #6c757d;
    margin: 0;
}
.apparati-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1rem;
}
.apparato-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}
.apparato-header {
    display: flex;
    align-items: center;
    padding: 1rem;
    gap: 1rem;
    background: #f8f9fa;
}
.apparato-icon {
    width: 45px;
    height: 45px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.9rem;
}
.apparato-info {
    flex: 1;
}
.apparato-info h4 {
    margin: 0;
    font-size: 1rem;
}
.tipo-badge {
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 4px;
}
.apparato-status {
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: bold;
}
.status-online { background: #28a745; color: white; }
.status-offline { background: #dc3545; color: white; }
.status-unknown { background: #6c757d; color: white; }
.status-checking { background: #ffc107; color: #212529; }
.apparato-body {
    padding: 1rem;
}
.info-row {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.3rem;
    font-size: 0.9rem;
}
.info-row .label {
    color: #6c757d;
    min-width: 70px;
}
.apparato-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: #f8f9fa;
    border-top: 1px solid #eee;
}
.credentials-icons {
    display: flex;
    gap: 0.3rem;
}
.cred-icon {
    background: #e9ecef;
    color: #495057;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.7rem;
    font-weight: bold;
}
.apparato-actions {
    display: flex;
    gap: 0.3rem;
}
.observium-status {
    background: #f8f9fa;
}
/* Modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}
.modal-content {
    background: white;
    border-radius: 8px;
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    overflow: hidden;
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #eee;
}
.modal-header h3 { margin: 0; }
.close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
}
.modal-body {
    padding: 1rem;
    overflow-y: auto;
    max-height: calc(80vh - 60px);
}
</style>
{{end}}
