{{template "base" .}}

{{define "content"}}
<div class="page-header">
    <h1>Gestione Navi</h1>
    <div class="header-actions">
        {{if .Session.IsTecnico}}
        <a href="/orari/upload" class="btn btn-secondary">Upload Orari Corsica</a>
        <a href="/navi/nuovo" class="btn btn-primary">‚ûï Nuova Nave</a>
        {{end}}
    </div>
</div>

{{if .Data}}
<div class="filters-bar">
    <input type="text" id="searchInput" placeholder="Cerca nave..." class="search-input">
    <label class="filter-checkbox">
        <input type="checkbox" id="filterLavori" onchange="filterNavi()">
        Mostra solo ferme per lavori
    </label>
</div>

<!-- Pulsanti Compagnie -->
<div class="compagnie-buttons mb-4">
    <button class="btn btn-compagnia active" data-compagnia="all" onclick="showCompagnia('all')">
        üìã Tutte
    </button>
    {{range .Data}}
    <button class="btn btn-compagnia" data-compagnia="{{.ID}}" onclick="showCompagnia({{.ID}})">
        {{if .Logo}}
        <img src="/compagnie/logo/{{.ID}}" alt="{{.Nome}}" class="btn-logo">
        {{else}}
        üè¢
        {{end}}
        {{.Nome}} <span class="badge bg-primary">{{len .Navi}}</span>
    </button>
    {{end}}
</div>

<!-- Lista Navi per Compagnia -->
{{range .Data}}
<div class="compagnia-section" data-compagnia-id="{{.ID}}">
    <div class="compagnia-header">
        {{if .Logo}}
        <img src="/compagnie/logo/{{.ID}}" alt="{{.Nome}}" class="compagnia-header-logo">
        {{end}}
        <h3>{{.Nome}}</h3>
        <span class="badge bg-primary">{{len .Navi}} navi</span>
    </div>

    <div class="navi-grid">
        {{range .Navi}}
        <div class="nave-card" data-ferma="{{if .FermaPerLavori}}1{{else}}0{{end}}" data-nome="{{.Nome | lower}}">
            <div class="nave-card-header">
                {{if .Foto}}
                <img src="/navi/foto/{{.ID}}" alt="{{.Nome}}" class="nave-thumb">
                {{else}}
                <div class="nave-thumb-placeholder">
                    üö¢
                </div>
                {{end}}
                <div class="nave-status">
                    {{if .FermaPerLavori}}
                    <span class="badge bg-warning text-dark">IN CANTIERE</span>
                    {{else}}
                    <span class="badge bg-success">ATTIVA</span>
                    {{end}}
                </div>
            </div>
            <div class="nave-card-body">
                <h4><a href="/navi/dettaglio/{{.ID}}">{{.Nome}}</a></h4>
                {{if .IMO}}<small class="text-muted">IMO: {{.IMO}}</small>{{end}}
                {{if .FermaPerLavori}}
                <div class="lavori-info mt-2">
                    {{if .DataInizioLavori}}
                    <small>üìÖ Dal: {{.DataInizioLavori.Format "02/01/2006"}}</small>
                    {{end}}
                    {{if .DataFineLavoriPrev}}
                    <small>‚úÖ Fine: {{.DataFineLavoriPrev.Format "02/01/2006"}}</small>
                    {{end}}
                </div>
                {{end}}
            </div>
            <div class="nave-card-footer">
                <a href="/navi/dettaglio/{{.ID}}" class="btn btn-sm btn-info" title="Dettagli">‚ÑπÔ∏è</a>
                <a href="/navi/rete/{{.ID}}" class="btn btn-sm btn-primary" title="Rete">üì∂</a>
                <a href="/navi/dettaglio/{{.ID}}#servers" class="btn btn-sm btn-success" title="Apparati">üñ•Ô∏è</a>
                <a href="/guasti-nave/{{.ID}}" class="btn btn-sm btn-danger" title="Guasti">‚ö†Ô∏è</a>
                {{if $.Session.IsTecnico}}
                <a href="/navi/modifica/{{.ID}}" class="btn btn-sm btn-secondary" title="Modifica">‚úèÔ∏è</a>
                {{end}}
            </div>
        </div>
        {{end}}
    </div>
</div>
{{end}}

{{else}}
<div class="empty-state">
    <h3>Nessuna nave trovata</h3>
    <p>Prima di aggiungere una nave, assicurati di aver creato almeno una compagnia.</p>
    {{if .Session.IsTecnico}}
    <a href="/navi/nuovo" class="btn btn-primary mt-2">Aggiungi la prima nave</a>
    {{end}}
</div>
{{end}}

<script>
document.getElementById('searchInput').addEventListener('keyup', filterNavi);

var activeCompagnia = 'all';

function showCompagnia(compagniaId) {
    activeCompagnia = compagniaId;

    // Aggiorna pulsanti
    document.querySelectorAll('.btn-compagnia').forEach(function(btn) {
        btn.classList.remove('active');
    });
    document.querySelector('[data-compagnia="' + compagniaId + '"]').classList.add('active');

    // Mostra/nascondi sezioni
    document.querySelectorAll('.compagnia-section').forEach(function(section) {
        if (compagniaId === 'all' || section.getAttribute('data-compagnia-id') == compagniaId) {
            section.style.display = '';
        } else {
            section.style.display = 'none';
        }
    });

    filterNavi();
}

function filterNavi() {
    var searchFilter = document.getElementById('searchInput').value.toLowerCase();
    var onlyFerme = document.getElementById('filterLavori').checked;

    document.querySelectorAll('.compagnia-section').forEach(function(section) {
        if (activeCompagnia !== 'all' && section.getAttribute('data-compagnia-id') != activeCompagnia) {
            return;
        }

        var cards = section.querySelectorAll('.nave-card');
        var visibleCount = 0;

        cards.forEach(function(card) {
            var nome = card.getAttribute('data-nome');
            var isFerma = card.getAttribute('data-ferma') === '1';
            var matchSearch = nome.includes(searchFilter);
            var matchFerma = !onlyFerme || isFerma;

            if (matchSearch && matchFerma) {
                card.style.display = '';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        // Nascondi sezione se nessuna nave visibile
        if (activeCompagnia === 'all') {
            section.style.display = visibleCount > 0 ? '' : 'none';
        }
    });
}
</script>

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1.5rem;
}
.header-actions {
    display: flex;
    gap: 0.5rem;
}
.filters-bar {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}
.filter-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

/* Pulsanti Compagnie */
.compagnie-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}
.btn-compagnia {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border: 2px solid #dee2e6;
    background: white;
    border-radius: 25px;
    font-weight: 500;
    transition: all 0.2s;
}
.btn-compagnia:hover {
    border-color: #0d6efd;
    background: #e7f1ff;
}
.btn-compagnia.active {
    border-color: #0d6efd;
    background: #0d6efd;
    color: white;
}
.btn-compagnia.active .badge {
    background: white !important;
    color: #0d6efd;
}
.btn-logo {
    height: 24px;
    width: auto;
    max-width: 60px;
    object-fit: contain;
}

/* Sezioni Compagnia */
.compagnia-section {
    margin-bottom: 2rem;
}
.compagnia-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 1rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px 8px 0 0;
}
.compagnia-header h3 {
    margin: 0;
    font-size: 1.1rem;
}
.compagnia-header-logo {
    height: 30px;
    width: auto;
    max-width: 80px;
    object-fit: contain;
    background: white;
    padding: 4px;
    border-radius: 4px;
}

/* Griglia Navi */
.navi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 0 0 8px 8px;
}

/* Card Nave */
.nave-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
}
.nave-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.nave-card-header {
    position: relative;
    height: 120px;
    background: #e9ecef;
}
.nave-thumb {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.nave-thumb-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #adb5bd;
    font-size: 3rem;
}
.nave-status {
    position: absolute;
    top: 8px;
    right: 8px;
}
.nave-card-body {
    padding: 1rem;
}
.nave-card-body h4 {
    margin: 0 0 0.25rem 0;
    font-size: 1.1rem;
}
.nave-card-body h4 a {
    color: #212529;
    text-decoration: none;
}
.nave-card-body h4 a:hover {
    color: #0d6efd;
}
.lavori-info {
    font-size: 0.85rem;
    color: #856404;
    background: #fff3cd;
    padding: 0.5rem;
    border-radius: 4px;
}
.lavori-info small {
    display: block;
}
.nave-card-footer {
    padding: 0.75rem 1rem;
    border-top: 1px solid #dee2e6;
    display: flex;
    gap: 0.5rem;
    justify-content: center;
}
.nave-card-footer .btn {
    flex: 1;
    max-width: 50px;
}

/* Responsive */
@media (max-width: 768px) {
    .navi-grid {
        grid-template-columns: 1fr;
    }
    .compagnie-buttons {
        justify-content: center;
    }
}
</style>
{{end}}
