{{template "base" .}}

{{define "content"}}
<div class="page-header">
    <h1>Gestione Navi</h1>
    <div class="header-actions">
        {{if .Session.IsTecnico}}
        <a href="/orari/upload" class="btn btn-secondary">Upload Orari Corsica</a>
        <a href="/navi/nuovo" class="btn btn-primary">Nuova Nave</a>
        {{end}}
    </div>
</div>

{{if .Data}}
<div class="filters-bar">
    <input type="text" id="searchInput" placeholder="Cerca nave..." class="search-input">
    <label class="filter-checkbox">
        <input type="checkbox" id="filterLavori" onchange="filterNavi()">
        Mostra solo ferme per lavori
    </label>
    <button class="btn btn-sm btn-outline-secondary" onclick="expandAll()"><i class="bi bi-arrows-expand"></i> Espandi</button>
    <button class="btn btn-sm btn-outline-secondary" onclick="collapseAll()"><i class="bi bi-arrows-collapse"></i> Chiudi</button>
</div>

<div class="accordion" id="accordionNavi">
    {{range .Data}}
    <div class="accordion-item compagnia-group">
        <h2 class="accordion-header">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{.ID}}" aria-expanded="true">
                <div class="d-flex align-items-center w-100">
                    <div class="compagnia-logo-box me-3">
                        {{if .Logo}}
                        <img src="/compagnie/logo/{{.ID}}" alt="Logo {{.Nome}}" class="compagnia-logo">
                        {{else}}
                        <div class="compagnia-logo-placeholder">
                            <i class="bi bi-building"></i>
                        </div>
                        {{end}}
                    </div>
                    <div class="flex-grow-1">
                        <strong>{{.Nome}}</strong>
                        <span class="badge bg-primary ms-2">{{len .Navi}} navi</span>
                    </div>
                </div>
            </button>
        </h2>
        <div id="collapse{{.ID}}" class="accordion-collapse collapse show">
            <div class="accordion-body p-0">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 100px;">Stato</th>
                            <th>Nome</th>
                            <th>IMO</th>
                            <th>Email Master</th>
                            <th style="width: 150px;">Lavori</th>
                            <th style="width: 280px;">Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Navi}}
                        <tr class="nave-row" data-ferma="{{if .FermaPerLavori}}1{{else}}0{{end}}" data-nome="{{.Nome | lower}}">
                            <td>
                                {{if .FermaPerLavori}}
                                <span class="badge bg-warning text-dark" title="Non raggiungibile da remoto">IN CANTIERE</span>
                                {{else}}
                                <span class="badge bg-success">ATTIVA</span>
                                {{end}}
                            </td>
                            <td><strong><a href="/navi/dettaglio/{{.ID}}">{{.Nome}}</a></strong></td>
                            <td>{{.IMO}}</td>
                            <td>{{if .EmailMaster}}<a href="mailto:{{.EmailMaster}}">{{.EmailMaster}}</a>{{end}}</td>
                            <td>
                                {{if .FermaPerLavori}}
                                    {{if .DataInizioLavori}}
                                    <small>Dal: {{.DataInizioLavori.Format "02/01/2006"}}</small><br>
                                    {{end}}
                                    {{if .DataFineLavoriPrev}}
                                    <small>Fine: {{.DataFineLavoriPrev.Format "02/01/2006"}}</small>
                                    {{end}}
                                {{else}}
                                -
                                {{end}}
                            </td>
                            <td class="table-actions">
                                <a href="/navi/dettaglio/{{.ID}}" class="btn btn-sm btn-info" title="Dettagli"><i class="bi bi-info-circle"></i></a>
                                <a href="/navi/rete/{{.ID}}" class="btn btn-sm btn-primary" title="Rete"><i class="bi bi-wifi"></i></a>
                                <a href="/guasti-nave/{{.ID}}" class="btn btn-sm btn-danger" title="Guasti"><i class="bi bi-exclamation-triangle"></i></a>
                                {{if $.Session.IsTecnico}}
                                <a href="/navi/modifica/{{.ID}}" class="btn btn-sm btn-secondary" title="Modifica"><i class="bi bi-pencil"></i></a>
                                <a href="/navi/elimina/{{.ID}}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Sei sicuro?')" title="Elimina"><i class="bi bi-trash"></i></a>
                                {{end}}
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {{end}}
</div>
{{else}}
<div class="empty-state">
    <h3>Nessuna nave trovata</h3>
    <p>Prima di aggiungere una nave, assicurati di aver creato almeno una compagnia.</p>
    {{if .Session.IsTecnico}}
    <a href="/navi/nuovo" class="btn btn-primary mt-2">Aggiungi la prima nave</a>
    {{end}}
</div>
{{end}}

<script>
document.getElementById('searchInput').addEventListener('keyup', filterNavi);

function filterNavi() {
    var searchFilter = document.getElementById('searchInput').value.toLowerCase();
    var onlyFerme = document.getElementById('filterLavori').checked;
    var rows = document.querySelectorAll('.nave-row');
    
    rows.forEach(function(row) {
        var nome = row.getAttribute('data-nome');
        var isFerma = row.getAttribute('data-ferma') === '1';
        var matchSearch = nome.includes(searchFilter);
        var matchFerma = !onlyFerme || isFerma;
        
        row.style.display = (matchSearch && matchFerma) ? '' : 'none';
    });
    
    // Nascondi compagnie senza navi visibili
    document.querySelectorAll('.compagnia-group').forEach(function(group) {
        var visibleRows = group.querySelectorAll('.nave-row:not([style*="display: none"])');
        group.style.display = visibleRows.length > 0 ? '' : 'none';
    });
}

function expandAll() {
    document.querySelectorAll('.accordion-collapse').forEach(function(el) {
        el.classList.add('show');
    });
    document.querySelectorAll('.accordion-button').forEach(function(el) {
        el.classList.remove('collapsed');
    });
}

function collapseAll() {
    document.querySelectorAll('.accordion-collapse').forEach(function(el) {
        el.classList.remove('show');
    });
    document.querySelectorAll('.accordion-button').forEach(function(el) {
        el.classList.add('collapsed');
    });
}
</script>

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1.5rem;
}
.header-actions {
    display: flex;
    gap: 0.5rem;
}
.filters-bar {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}
.filter-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}
.accordion-button {
    font-size: 1.1rem;
    background-color: #f8f9fa;
    padding: 0.75rem 1rem;
}
.accordion-button:not(.collapsed) {
    background-color: #e7f1ff;
    color: #0c63e4;
}
.accordion-item {
    margin-bottom: 0.5rem;
    border-radius: 0.5rem;
    overflow: hidden;
}
.compagnia-logo-box {
    width: 60px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border-radius: 4px;
    padding: 4px;
    border: 1px solid #dee2e6;
}
.compagnia-logo {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}
.compagnia-logo-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #adb5bd;
    font-size: 1.5rem;
}
.table-actions {
    white-space: nowrap;
}
.table-actions .btn {
    margin-right: 0.25rem;
}
.btn-info {
    background: #17a2b8;
    color: white;
    border-color: #17a2b8;
}
.btn-info:hover {
    background: #138496;
    color: white;
}
</style>
{{end}}
