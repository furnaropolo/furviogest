{{template "base" .}}

{{define "content"}}
<div class="page-header d-flex justify-content-between align-items-center">
    <h1>Rapporto Intervento #{{.Data.Rapporto.ID}}</h1>
    <div class="btn-group">
        <a href="/rapporti/modifica/{{.Data.Rapporto.ID}}" class="btn btn-warning"><i class="bi bi-pencil"></i> Modifica</a>
        <button class="btn btn-info" onclick="anteprimaPDF()"><i class="bi bi-eye"></i> Anteprima PDF</button>
        <button class="btn btn-primary" onclick="scaricaPDF()"><i class="bi bi-download"></i> Scarica PDF</button>
        <button class="btn btn-danger" onclick="confermaElimina()"><i class="bi bi-trash"></i> Elimina</button>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-info-circle"></i> Informazioni Intervento
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Nave:</strong> {{.Data.Rapporto.NomeNave}} ({{.Data.Rapporto.NomeCompagnia}})</p>
                        <p><strong>Porto:</strong> {{.Data.Rapporto.NomePorto}}</p>
                        <p><strong>Tipo:</strong> 
                            {{if eq .Data.Rapporto.Tipo "wifi"}}<span class="badge bg-info">WiFi</span>
                            {{else if eq .Data.Rapporto.Tipo "gsm"}}<span class="badge bg-success">GSM</span>
                            {{else}}<span class="badge bg-secondary">{{.Data.Rapporto.Tipo}}</span>{{end}}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Data Inizio:</strong> {{.Data.Rapporto.DataIntervento}}</p>
                        {{if .Data.Rapporto.DataFine}}<p><strong>Data Fine:</strong> {{.Data.Rapporto.DataFine}}</p>{{end}}
                    </div>
                </div>
                <hr>
                <h6>Descrizione Lavoro:</h6>
                <p class="text-pre">{{.Data.Rapporto.Descrizione}}</p>
                {{if .Data.Rapporto.Note}}
                <h6>Note:</h6>
                <p class="text-pre">{{.Data.Rapporto.Note}}</p>
                {{end}}
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <i class="bi bi-people"></i> Tecnici e Ore Lavoro
            </div>
            <div class="card-body">
                {{if .Data.Tecnici}}
                <table class="table table-sm">
                    <thead><tr><th>Tecnico</th><th>Ore Lavoro</th></tr></thead>
                    <tbody>
                    {{range .Data.Tecnici}}
                    <tr>
                        <td>{{.Cognome}} {{.Nome}}</td>
                        <td>{{if .OreLavoro}}{{.OreLavoro}} ore{{else}}-{{end}}</td>
                    </tr>
                    {{end}}
                    </tbody>
                </table>
                {{else}}
                <p class="text-muted">Nessun tecnico assegnato</p>
                {{end}}
            </div>
        </div>

        {{if .Data.MaterialeUtilizzato}}
        <div class="card mb-3">
            <div class="card-header bg-warning">
                <i class="bi bi-box-seam"></i> Materiale Utilizzato
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <thead><tr><th>Prodotto</th><th>Quantità</th><th>Unità</th></tr></thead>
                    <tbody>
                    {{range .Data.MaterialeUtilizzato}}
                    <tr>
                        <td>{{.DescrizioneProdotto}}</td>
                        <td>{{.Quantita}}</td>
                        <td>{{.Unita}}</td>
                    </tr>
                    {{end}}
                    </tbody>
                </table>
            </div>
        </div>
        {{end}}

        {{if .Data.MaterialeRecuperato}}
        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <i class="bi bi-recycle"></i> Materiale Recuperato
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <thead><tr><th>Prodotto</th><th>Quantità</th><th>Unità</th></tr></thead>
                    <tbody>
                    {{range .Data.MaterialeRecuperato}}
                    <tr>
                        <td>{{.DescrizioneProdotto}}</td>
                        <td>{{.Quantita}}</td>
                        <td>{{.Unita}}</td>
                    </tr>
                    {{end}}
                    </tbody>
                </table>
            </div>
        </div>
        {{end}}

        {{if .Data.Rapporto.ConsiderazioniFinali}}
        <div class="card mb-3">
            <div class="card-header bg-secondary text-white">
                <i class="bi bi-chat-left-text"></i> Considerazioni Finali
            </div>
            <div class="card-body">
                <p class="text-pre">{{.Data.Rapporto.ConsiderazioniFinali}}</p>
            </div>
        </div>
        {{end}}
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <i class="bi bi-camera"></i> Foto Intervento
            </div>
            <div class="card-body">
                {{if .Data.Foto}}
                <div class="foto-gallery">
                    {{range .Data.Foto}}
                    <div class="foto-item" onclick="apriLightbox('/uploads/rapporti/{{.FilePath}}')">
                        <img src="/uploads/rapporti/{{.FilePath}}" alt="{{.Descrizione}}">
                        {{if .Descrizione}}<small>{{.Descrizione}}</small>{{end}}
                    </div>
                    {{end}}
                </div>
                {{else}}
                <p class="text-muted">Nessuna foto allegata</p>
                {{end}}
            </div>
        </div>
    </div>
</div>

<div class="mt-3">
    <a href="/rapporti" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Torna alla Lista</a>
</div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" onclick="chiudiLightbox()">
    <img id="lightboxImg" src="">
</div>

<style>
.text-pre { white-space: pre-wrap; }
.foto-gallery { display: flex; flex-wrap: wrap; gap: 10px; }
.foto-item { 
    width: 100px; height: 100px; cursor: pointer; position: relative;
    border: 1px solid #ddd; border-radius: 4px; overflow: hidden;
}
.foto-item img { width: 100%; height: 100%; object-fit: cover; }
.foto-item small { 
    position: absolute; bottom: 0; left: 0; right: 0;
    background: rgba(0,0,0,0.7); color: white; font-size: 0.7rem;
    padding: 2px 4px; text-align: center;
}
.lightbox {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center;
}
.lightbox.active { display: flex; }
.lightbox img { max-width: 90%; max-height: 90%; }
</style>

<script>
function apriLightbox(src) {
    document.getElementById('lightboxImg').src = src;
    document.getElementById('lightbox').classList.add('active');
}
function chiudiLightbox() {
    document.getElementById('lightbox').classList.remove('active');
}
function confermaElimina() {
    if (confirm('Sei sicuro di voler eliminare DEFINITIVAMENTE questo rapporto?\nQuesta azione non può essere annullata.')) {
        window.location.href = '/rapporti/elimina/{{.Data.Rapporto.ID}}';
    }
}
function anteprimaPDF() {
    window.open('/rapporti/pdf/{{.Data.Rapporto.ID}}?preview=1', '_blank');
}
function scaricaPDF() {
    window.location.href = '/rapporti/pdf/{{.Data.Rapporto.ID}}';
}
</script>
{{end}}
