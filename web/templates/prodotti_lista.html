{{template "base" .}}

{{define "content"}}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-box-seam me-2"></i>Magazzino</h2>
        <a href="/magazzino/nuovo" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i> Nuovo Prodotto
        </a>
    </div>

    {{if .Error}}
    <div class="alert alert-danger">{{.Error}}</div>
    {{end}}

    <!-- Filtri -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Tipo</label>
                    <select name="tipo" class="form-select">
                        <option value="">Tutti</option>
                        <option value="wifi" {{if eq .Data.FiltroTipo "wifi"}}selected{{end}}>WiFi</option>
                        <option value="gsm" {{if eq .Data.FiltroTipo "gsm"}}selected{{end}}>GSM</option>
                        <option value="entrambi" {{if eq .Data.FiltroTipo "entrambi"}}selected{{end}}>Entrambi</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Origine</label>
                    <select name="origine" class="form-select">
                        <option value="">Tutti</option>
                        <option value="nuovo" {{if eq .Data.FiltroOrigine "nuovo"}}selected{{end}}>Nuovo (acquistato)</option>
                        <option value="spare" {{if eq .Data.FiltroOrigine "spare"}}selected{{end}}>Spare (da nave)</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Categoria</label>
                    <select name="categoria" class="form-select">
                        <option value="">Tutte</option>
                        <option value="materiale" {{if eq .Data.FiltroCategoria "materiale"}}selected{{end}}>Materiale</option>
                        <option value="cavo" {{if eq .Data.FiltroCategoria "cavo"}}selected{{end}}>Cavo</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-funnel me-1"></i> Filtra
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabella prodotti -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Codice</th>
                            <th>Nome</th>
                            <th>Categoria</th>
                            <th>Tipo</th>
                            <th>Origine</th>
                            <th class="text-end">Giacenza</th>
                            <th width="120">Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Data.Prodotti}}
                        <tr>
                            <td><code>{{.Codice}}</code></td>
                            <td>
                                <strong>{{.Nome}}</strong>
                                {{if .Descrizione}}<br><small class="text-muted">{{.Descrizione}}</small>{{end}}
                            </td>
                            <td>
                                {{if eq .Categoria "cavo"}}
                                <span class="badge bg-info">Cavo</span>
                                {{else}}
                                <span class="badge bg-secondary">Materiale</span>
                                {{end}}
                            </td>
                            <td>
                                {{if eq .Tipo "wifi"}}
                                <span class="badge bg-primary">WiFi</span>
                                {{else if eq .Tipo "gsm"}}
                                <span class="badge bg-success">GSM</span>
                                {{else}}
                                <span class="badge bg-warning text-dark">WiFi+GSM</span>
                                {{end}}
                            </td>
                            <td>
                                {{if eq .Origine "spare"}}
                                <span class="badge bg-secondary">Spare</span>
                                {{if .NaveOrigine}}<br><small>{{.NaveOrigine}}</small>{{end}}
                                {{else}}
                                <span class="badge bg-primary">Nuovo</span>
                                {{end}}
                            </td>
                            <td class="text-end">
                                <span class="{{if le .Giacenza 0.0}}text-danger fw-bold{{end}}">
                                    {{printf "%.0f" .Giacenza}} {{.UnitaMisura}}
                                </span>
                            </td>
                            <td>
                                <a href="/magazzino/modifica/{{.ID}}" class="btn btn-sm btn-outline-primary" title="Modifica/Dettaglio">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="confermaEliminazione({{.ID}}, '{{.Codice}}')" title="Elimina">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {{else}}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                Nessun prodotto in magazzino
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal conferma eliminazione -->
<div class="modal fade" id="modalEliminazione" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Conferma Eliminazione</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Sei sicuro di voler eliminare il prodotto <strong id="codiceProdotto"></strong>?</p>
                <p class="text-muted">Verranno eliminati anche tutti i movimenti di acquisto collegati.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <a href="#" id="btnConfermaElimina" class="btn btn-danger">Elimina</a>
            </div>
        </div>
    </div>
</div>

<script>
function confermaEliminazione(id, codice) {
    document.getElementById('codiceProdotto').textContent = codice;
    document.getElementById('btnConfermaElimina').href = '/magazzino/elimina/' + id;
    new bootstrap.Modal(document.getElementById('modalEliminazione')).show();
}
</script>
{{end}}
